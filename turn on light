//definição dos pinos
//D0= 16
//D1= 5
//D2= 4
//D3= 0
//D4= 2
//D5= 14
//D6= 12
//D7= 13
//D8= 15

/*********************** Inclusão de bibliotecas ********************/
#include <ESP8266WiFi.h>              
#include "Adafruit_MQTT.h"            
#include "Adafruit_MQTT_Client.h"     
#include "DHT.h"                      

/******************* Definição de Constantes ****************************/
const int Sala = 4;                  
const int Quarto = 2;                
const int Cozinha = 14;              
const int Banheiro = 13;             


/*******************Sensor de temperatura e umidade*************************/

#define DHTPIN 5                             
#define DHTTYPE DHT11                        
DHT dht(DHTPIN, DHTTYPE, 15);                

/******************* Configurações da Rede Wi-Fi ***************************/


#define WLAN_SSID       "xxxxxx"  
#define WLAN_PASS       "xxxxxx"          
 
/************************* Configurações Adafruit.io *********************************/

#define AIO_SERVER      "io.adafruit.com"      
#define AIO_SERVERPORT  1883                   
#define AIO_USERNAME  "Danielengcomp2021"         
#define AIO_KEY       "key " 


/*************************** Configurações Globais  ***********************************/

WiFiClient client;                                                                       
Adafruit_MQTT_Client mqtt(&client, AIO_SERVER, AIO_SERVERPORT, AIO_USERNAME, AIO_KEY);  

/****************************** Feeds ***************************************/



Adafruit_MQTT_Subscribe sala = Adafruit_MQTT_Subscribe(&mqtt, AIO_USERNAME "/feeds/sala");  
Adafruit_MQTT_Subscribe quarto = Adafruit_MQTT_Subscribe(&mqtt, AIO_USERNAME "/feeds/quarto"); 
Adafruit_MQTT_Subscribe cozinha = Adafruit_MQTT_Subscribe(&mqtt, AIO_USERNAME "/feeds/cozinha"); 
Adafruit_MQTT_Subscribe banheiro = Adafruit_MQTT_Subscribe(&mqtt, AIO_USERNAME "/feeds/banheiro"); 
Adafruit_MQTT_Publish temperature = Adafruit_MQTT_Publish(&mqtt, AIO_USERNAME "/feeds/temperatura"); 
Adafruit_MQTT_Publish humidity = Adafruit_MQTT_Publish(&mqtt, AIO_USERNAME "/feeds/umidade"); 

/*************************** Laço de conexão MQTT ************************************/

void MQTT_connect();    

/*************************** Laço de configuração************************************/

void setup() {         
  
  dht.begin();             
  
  pinMode(Sala, OUTPUT); 
  pinMode(Quarto, OUTPUT); 
  pinMode(Cozinha, OUTPUT); 
  pinMode(Banheiro, OUTPUT); 
  
  Serial.begin(115200);  
  delay(10);            

  WiFi.begin(WLAN_SSID, WLAN_PASS);  
  while (WiFi.status() != WL_CONNECTED) { 
    delay(500);                    
                                        }

  mqtt.subscribe(&sala);   
  mqtt.subscribe(&quarto); 
  mqtt.subscribe(&cozinha); 
  mqtt.subscribe(&banheiro); 
             }


uint32_t x=0;  

/*************************** Laço de repetição************************************/

void loop() {  

  MQTT_connect();                           
  int umid = (int)dht.readHumidity();       
  int tempe = (int)dht.readTemperature();   

  if (! temperature.publish(tempe))        
    Serial.println(F("Falha na publicação da temperatura")); 
  else                                        
   Serial.println(F("Temperatura publicada!")); 
  if (! humidity.publish(umid))  
    Serial.println(F("Falha na publicação da umidade")); 
  else                                                   
    Serial.println(F("Umidade publicada!"));            
    
  Adafruit_MQTT_Subscribe *subscription;                
  while ((subscription = mqtt.readSubscription(5000))) { 

    
    if (subscription == &sala) {      
      
      if (strcmp((char *)sala.lastread, "desliga") == 0) { 
         digitalWrite(Sala, LOW);                        
                                                       }
      if (strcmp((char *)sala.lastread, "liga") == 0) { 
        digitalWrite(Sala, HIGH);                           
                                                          }
                               }
    
    if (subscription == &quarto) {    
      
      if (strcmp((char *)quarto.lastread, "desliga") == 0) { 
        digitalWrite(Quarto, LOW);                         
                                                         }
      if (strcmp((char *)quarto.lastread, "liga") == 0) { 
        digitalWrite(Quarto, HIGH);                          
                                                            }
                                 }

     
     if (subscription == &cozinha) {  
      
      if (strcmp((char *)cozinha.lastread, "desliga") == 0) { 
        digitalWrite(Cozinha, LOW);                         
                                                          }
      if (strcmp((char *)cozinha.lastread, "liga") == 0) { 
        digitalWrite(Cozinha, HIGH);                           
                                                             }
                                   }
     
     if (subscription == &banheiro) { 
      
      if (strcmp((char *)banheiro.lastread, "desliga") == 0) {  
        digitalWrite(Banheiro, LOW);                          
                                                           }
      if (strcmp((char *)banheiro.lastread, "liga") == 0) { 
        digitalWrite(Banheiro, HIGH);                          
                                                              }
                                      }
    
  }

  if(! mqtt.ping()) {      
    mqtt.disconnect();    
                    }

}

/*************************** Laço de conexão************************************/

void MQTT_connect() {        
  
  int8_t ret;             


  if (mqtt.connected()) {   
    return;                 
  }

  Serial.print("Conectando... ");   

  uint8_t retries = 3;      
  while ((ret = mqtt.connect()) != 0) { 
       Serial.println(mqtt.connectErrorString(ret)); 
       Serial.println("Reconectando em 5s..."); 
       mqtt.disconnect();   
       delay(5000);  
       retries--;     
       if (retries == 0) {
         while (1);
       }
  }
  Serial.println("Conectado!");   
}

